<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Classroom</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4a90e2">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
    <link rel="manifest" href="manifest.json">

    <style>
        @font-face {
            font-family: 'ZhuyinFont';
            src: url('./fonts/zhuyin.ttf') format('truetype'),
                 url('zhuyin.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            --primary: #4a90e2;
            --hunter-bg: #e3f2fd;
            --angus-bg: #fff3cd;
        }

        body {
            font-family: "Microsoft JhengHei", -apple-system, sans-serif;
            background: #f4f6f8;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .role-info h2, .role-info p, .menu-title, .menu-sub, .q-text, .q-sub, .opt-btn, .hint-toggle, .use-zhuyin, .btn {
            font-family: 'ZhuyinFont', "Microsoft JhengHei", sans-serif !important;
            font-weight: normal;
        }

        .no-zhuyin {
            font-family: "Microsoft JhengHei", -apple-system, sans-serif !important;
        }

        .hidden { display: none !important; }
        .btn { border: none; border-radius: 16px; cursor: pointer; transition: 0.2s; font-weight: bold; outline: none; display: flex; align-items: center; justify-content: center; }
        .btn:active { transform: scale(0.96); }
        .icon-btn { background: #eee; width: 60px; height: 60px; border-radius: 50%; font-size: 30px; border: none; cursor: pointer; }
        
        .navbar { width: 100%; padding: 15px 25px; background: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; box-sizing: border-box; }
        .score-board { font-size: 24px; color: #555; font-weight: bold; font-family: -apple-system, sans-serif; }

        #home-view { display: flex; flex-direction: column; gap: 25px; margin-top: 8vh; width: 90%; max-width: 450px; }
        .role-card { background: white; padding: 30px; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 25px; cursor: pointer; transition: 0.3s; }
        .role-card:active { transform: scale(0.98); }
        .role-avatar { font-size: 50px; background: #eee; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .role-info h2 { margin: 0; font-size: 32px; color: #333; }
        .role-info p { margin: 8px 0 0; color: #888; font-size: 18px; }
        
        .hunter-app { background: var(--hunter-bg); }
        .angus-app { background: var(--angus-bg); }
        
        .menu-list { display: grid; grid-template-columns: 1fr; gap: 20px; width: 90%; max-width: 550px; padding: 20px 0; }
        .menu-item { background: white; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-left: 10px solid var(--primary); display: flex !important; width: 100% !important; box-sizing: border-box; min-height: 100px; justify-content: center; align-items: center; }
        .menu-title { font-size: 36px; color: #333; margin: 0; display: inline-block; line-height: 1.4; white-space: nowrap; }
        .menu-sub { font-size: 18px; color: #888; display: block; margin-top: 5px; }

        .quiz-container { width: 95%; max-width: 900px; display: flex; flex-direction: column; align-items: center; padding-top: 20px; }
        .card { background: white; width: 100%; padding: 40px 20px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; margin-bottom: 30px; position: relative; box-sizing: border-box; }
        
        /* È°åÁõÆÂ§ßÂ≠ó (È†êË®≠ 100pxÔºåÊúÉË¢´ JS ÂãïÊÖã‰øÆÊîπ) */
        .q-text { 
            font-size: 100px; 
            color: #333; 
            margin: 20px 0; 
            min-height: 120px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            line-height: 1.2; 
            white-space: nowrap; /* Á¶ÅÊ≠¢ÊèõË°åÔºåËÆì‰ªñËá™ÂãïÁ∏ÆÂ∞è */
        }
        
        .q-sub { font-size: 24px; color: #666; margin-top: 5px; margin-bottom: 15px; white-space: nowrap; }

        .options-grid { display: flex; width: 100%; gap: 20px; flex-direction: row; justify-content: center; flex-wrap: wrap; }
        
        .opt-btn { 
            background: white; 
            border: 4px solid #f0f0f0; 
            padding: 5px; 
            font-size: 42px; /* ÈÅ∏È†ÖÂ≠óÈ´îÈÅ©‰∏≠ */
            border-radius: 25px; 
            color: #555; 
            min-height: 120px; 
            box-shadow: 0 6px 0 #ddd; 
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;                   
            min-width: 140px;          
            max-width: 300px;
            white-space: nowrap;
        }

        .opt-btn:active { transform: translateY(6px); box-shadow: none; }
        .opt-btn.correct { background: #d4edda; border-color: #28a745; color: #155724; box-shadow: 0 6px 0 #1e7e34; }
        .opt-btn.wrong { background: #f8d7da; border-color: #dc3545; color: #721c24; box-shadow: 0 6px 0 #bd2130; }

        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; max-width: 500px; }
        .num-btn { background: white; padding: 20px; font-size: 32px; border-radius: 15px; box-shadow: 0 6px 0 #ccc; color: #333; border: 1px solid #ddd; }
        .num-btn:active { box-shadow: none; transform: translateY(6px); }
        .action-btn { background: var(--primary); color: white; box-shadow: 0 6px 0 #2a6bb3; border: none; }
        .half-btn { grid-column: span 3; background: #e1f5fe; font-size: 26px; }

        #math-input { font-size: 60px !important; height: 70px !important; margin-bottom: 20px; }
        .hint-toggle { margin-top: 15px; background: #fff3cd; color: #856404; padding: 10px 25px; font-size: 20px; border-radius: 25px; }
        canvas { background: white; border-radius: 50%; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; max-width: 100%; }
    </style>
</head>
<body>

    <nav id="navbar" class="navbar hidden">
        <div class="btn" onclick="goHome()" style="font-size:24px;">üè†</div>
        <div id="nav-title" style="font-size: 20px; color:#4a90e2;" class="use-zhuyin">Classroom</div>
        <div class="score-board">‚≠ê <span id="score">0</span></div>
    </nav>

    <div id="home-view">
        <div class="role-card" onclick="selectRole('hunter')" style="border-left: 6px solid #4facfe;">
            <div class="role-avatar" style="background:#e3f2fd;">üë¶</div>
            <div class="role-info">
                <h2>Âì•Âì• Hunter</h2>
                <p>ÂúãË™û„ÄÅÊï∏Â≠∏„ÄÅËã±Êñá</p>
            </div>
        </div>
        <div class="role-card" onclick="selectRole('angus')" style="border-left: 6px solid #ff9a9e;">
            <div class="role-avatar" style="background:#fff3cd;">üë∂</div>
            <div class="role-info">
                <h2>ÂºüÂºü Angus</h2>
                <p>Ê≥®Èü≥„ÄÅÊï∏Êï∏„ÄÅÊôÇÈêò</p>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden"></div>

    <script src="questions.js"></script>

    <script>
        let currentRole = null;
        let score = 0;
        let currentQ = null;
        let inputBuffer = ""; 
        let mathConfig = null;

        function selectRole(role) {
            currentRole = role;
            document.getElementById('home-view').classList.add('hidden');
            document.getElementById('navbar').classList.remove('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            document.body.className = role === 'hunter' ? 'hunter-app' : 'angus-app';
            document.getElementById('nav-title').innerText = role === 'hunter' ? 'Hunter Â∞àÂ±¨' : 'Angus Â∞àÂ±¨';
            if (role === 'hunter') { showHunterCategories(); } 
            else { showAngusCategories(); }
        }

        function goHome() {
            document.getElementById('home-view').classList.remove('hidden');
            document.getElementById('navbar').classList.add('hidden');
            document.getElementById('app-container').classList.add('hidden');
            document.body.className = '';
            currentRole = null;
        }

        function showHunterCategories() {
            const container = document.getElementById('app-container');
            container.innerHTML = `<div class="menu-list" id="menu-list"></div>`;
            const list = document.getElementById('menu-list');
            addMenuItem(list, "üìö ÂúãË™û", "", () => showHunterSubject('chinese'), '#ff9a9e');
            addMenuItem(list, "üî¢ Êï∏Â≠∏", "", () => showHunterSubject('math'), '#4facfe');
            addMenuItem(list, "üî§ Ëã±Êñá", "", () => showHunterSubject('english'), '#a8e6cf');
        }

        function showHunterSubject(subject) {
            const container = document.getElementById('app-container');
            container.innerHTML = `<div class="menu-list" id="menu-list"></div>`;
            const list = document.getElementById('menu-list');
            addBackBtn(list, "‚¨ÖÔ∏è ÂõûÁßëÁõÆÈÅ∏ÂñÆ", () => showHunterCategories());

            if (subject === 'chinese') {
                addMenuItem(list, "ÂúàË©ûÊ≥®Èü≥Á∑¥Áøí", "ËÅΩÈü≥ÈÅ∏Ê≥®Èü≥", () => startQuiz('h_zhuyin'));
            } else if (subject === 'math') {
                DB.hunter.mathUnits.forEach(u => addMenuItem(list, u.name, u.desc, () => startMath(u)));
            } else if (subject === 'english') {
                addMenuItem(list, "ÈõôË™ûÁπ™Êú¨ÂñÆÂ≠ó", "ËÅΩÈü≥Ëæ®Â≠ó", () => startQuiz('h_english'));
            }
        }

        function showAngusCategories() {
            const container = document.getElementById('app-container');
            container.innerHTML = `<div class="menu-list" id="menu-list"></div>`;
            const list = document.getElementById('menu-list');
            addMenuItem(list, "üó£Ô∏è Ê≥®Èü≥", "", () => showAngusSubject('zhuyin'), '#ffd1dc');
            addMenuItem(list, "üçé Êï∏Êï∏", "", () => showAngusSubject('math'), '#fff5ba');
            addMenuItem(list, "üê∂ Ëã±Êñá", "", () => showAngusSubject('english'), '#baffc9');
        }

        function showAngusSubject(subject) {
            const container = document.getElementById('app-container');
            container.innerHTML = `<div class="menu-list" id="menu-list"></div>`;
            const list = document.getElementById('menu-list');
            addBackBtn(list, "‚¨ÖÔ∏è ÂõûÂéªÈÅ∏Âà•ÁöÑ", () => showAngusCategories());

            if (subject === 'zhuyin') {
                addMenuItem(list, "Ê≥®Èü≥Á¨¶ËôüÊâæÊâæÁúã", "", () => startQuiz('a_zhuyin'));
            } else if (subject === 'math') {
                DB.angus.mathUnits.forEach(u => addMenuItem(list, u.name, u.desc, () => startMath(u)));
            } else if (subject === 'english') {
                addMenuItem(list, "Á∞°ÂñÆÂñÆÂ≠ó", "", () => startQuiz('a_english'));
            }
        }

        function addMenuItem(parent, title, sub, action, color) {
            const btn = document.createElement('button');
            btn.className = 'menu-item btn';
            if (color) btn.style.borderLeftColor = color; 
            let htmlContent = (sub && sub !== "") ? 
                `<div><span class="menu-title">${title}</span><span class="menu-sub">${sub}</span></div>` :
                `<span class="menu-title" style="margin:0;">${title}</span>`;
            btn.innerHTML = htmlContent;
            btn.onclick = action;
            parent.appendChild(btn);
        }

        function addBackBtn(parent, title, action) {
            const btn = document.createElement('button');
            btn.className = 'menu-item btn';
            btn.style.background = '#f8f9fa'; 
            btn.style.borderLeft = 'none';
            btn.style.boxShadow = 'none';
            btn.style.border = '2px dashed #ddd';
            btn.innerHTML = `<span class="menu-title" style="font-size:24px; color:#888; margin:0;">${title}</span>`;
            btn.onclick = action;
            parent.appendChild(btn);
        }

        function generateConfusingOptions(correctZhuyin) {
            const confusionMap = {
                '„Ñ£': '„Ñ•', '„Ñ•': '„Ñ£', '„Ñ¢': '„Ñ§', '„Ñ§': '„Ñ¢',
                '„Ñì': '„Ñó', '„Ñó': '„Ñì', '„Ñï': '„Ñô', '„Ñô': '„Ñï',
                '„Ñî': '„Ñò', '„Ñò': '„Ñî', '„Ñå': '„Ññ', '„Ññ': '„Ñå',
                '„ÑÖ': '„ÑÜ', '„ÑÜ': '„ÑÖ', '„Ñâ': '„Ñä', '„Ñä': '„Ñâ',
                '„Ñç': '„Ñé', '„Ñé': '„Ñç', '„Ñê': '„Ñë', '„Ñë': '„Ñê',
                '„Ñ®': '„Ñ©', '„Ñ©': '„Ñ®', '„Ñü': '„Ñù', '„Ñù': '„Ñü',
                '„Ñ°': '„Ñõ', '„Ñõ': '„Ñ°',
                'Àä': 'Àá', 'Àá': 'Àã', 'Àã': 'Àô', 'Àô': '' 
            };

            let options = new Set();
            options.add(correctZhuyin);

            let toneDistractor = correctZhuyin;
            const tones = ['Àä', 'Àá', 'Àã', 'Àô'];
            // ÂòóË©¶ÊõøÊèõÊúÄÂæå‰∏ÄÂÄãÂ≠óÁöÑËÅ≤Ë™ø
            if (tones.includes(correctZhuyin.slice(-1))) {
                toneDistractor = correctZhuyin.slice(0, -1) + (correctZhuyin.slice(-1) === 'Àä' ? 'Àá' : 'Àä');
            } else {
                toneDistractor = correctZhuyin + 'Àä';
            }
            options.add(toneDistractor);

            let confusingDistractor = correctZhuyin;
            for (let char of correctZhuyin) {
                if (confusionMap[char]) {
                    confusingDistractor = correctZhuyin.replace(char, confusionMap[char]);
                    options.add(confusingDistractor);
                    break;
                }
            }

            while (options.size < 3) {
                // Èö®Ê©üÁî¢ÁîüÂπ≤ÊìæÈ†ÖÔºåÈï∑Â∫¶Á®çÂæÆË∑üÁ≠îÊ°àÂ∑Æ‰∏çÂ§ö
                let randomZ = DB.angus.zhuyin[Math.floor(Math.random() * DB.angus.zhuyin.length)];
                // Â¶ÇÊûúÁ≠îÊ°àÊúâÂÖ©ÂÄãÂ≠ó(ÊúâÁ©∫Ê†º)ÔºåÈö®Ê©ü‰πüÂä†ÂÄãÁ©∫Ê†º
                if(correctZhuyin.includes(' ')) {
                     randomZ += " " + DB.angus.zhuyin[Math.floor(Math.random() * DB.angus.zhuyin.length)];
                }
                options.add(randomZ + (Math.random()>0.5 ? 'Àä' : ''));
            }
            return Array.from(options);
        }

        function startQuiz(type) {
            score = 0;
            document.getElementById('score').innerText = 0;
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="quiz-container">
                    <div class="card">
                        <button class="icon-btn" onclick="speakCurrent()">üîä</button>
                        <div id="q-display" class="q-text"></div>
                        <div id="q-sub-display" class="q-sub"></div>
                        <div id="hint-btn" class="hidden"></div>
                    </div>
                    <div id="opt-container" class="options-grid"></div>
                    <button class="btn" onclick="backToMenu()" style="margin-top:30px; color:#888; font-size:20px; background:none;">‚¨ÖÔ∏è ÁµêÊùüÁ∑¥Áøí</button>
                </div>`;
            nextQuizQuestion(type);
        }

        function nextQuizQuestion(type) {
            let qData, options;
            
            if (type === 'h_zhuyin') { 
                qData = getRandom(DB.hunter.chinese_zhuyin); 
                options = shuffle(generateConfusingOptions(qData.a));
            }
            else if (type === 'h_english') { 
                qData = getRandom(DB.hunter.english); 
                let wrongs = DB.hunter.english.filter(x => x.q !== qData.q).map(x => x.q);
                options = shuffle([qData.q, ...shuffle(wrongs).slice(0,3)]);
            }
            else if (type === 'a_zhuyin') {
                let char = getRandom(DB.angus.zhuyin);
                qData = { q: "?", a: char, audio: char, speak: "Ë´ãÊâæÂá∫ "+char };
                let wrongs = DB.angus.zhuyin.filter(x => x !== char);
                options = shuffle([char, ...shuffle(wrongs).slice(0,3)]);
            }
            else if (type === 'a_english') {
                qData = getRandom(DB.angus.english);
                let wrongs = DB.angus.english.filter(x => x.q !== qData.q).map(x => x.q);
                options = shuffle([qData.q, ...shuffle(wrongs).slice(0,3)]);
            }

            currentQ = qData;
            const display = document.getElementById('q-display');
            const subDisplay = document.getElementById('q-sub-display');
            subDisplay.innerHTML = "";

            if (type === 'h_zhuyin') {
                display.className = 'q-text no-zhuyin'; 
                display.innerHTML = qData.q;
            } else {
                display.className = 'q-text use-zhuyin'; 
                if (type.includes('english')) display.innerHTML = currentRole==='hunter' ? "???" : qData.q;
                else if (type === 'a_zhuyin') display.innerHTML = "?";
            }

            // üõ†Ô∏è Êô∫ÊÖßÂ≠óÈ´îÁ∏ÆÊîæÈÇèËºØ (Smart Resizer)
            let textLen = display.innerText.length;
            if (textLen <= 1) display.style.fontSize = "100px";
            else if (textLen === 2) display.style.fontSize = "80px";
            else if (textLen === 3) display.style.fontSize = "60px";
            else display.style.fontSize = "45px";

            const hintDiv = document.getElementById('hint-btn');
            if (type.includes('english') && qData.hint) {
                hintDiv.className = 'btn hint-toggle';
                hintDiv.innerText = "üí° ÁúãÊèêÁ§∫";
                hintDiv.onclick = () => { display.innerText = qData.hint; };
                hintDiv.classList.remove('hidden');
            } else { hintDiv.classList.add('hidden'); }

            setTimeout(() => speakCurrent(), 300);

            const optContainer = document.getElementById('opt-container');
            optContainer.innerHTML = '';
            options.forEach(opt => {
                let btn = document.createElement('button');
                btn.className = 'opt-btn btn';
                btn.innerText = opt;
                
                // ÈÅ∏È†ÖÂ≠óÈ´î‰πüÂæÆË™ø‰∏Ä‰∏ãÔºåÂ¶ÇÊûúÈÅ∏È†ÖÂ§™Èï∑Â∞±Á∏ÆÂ∞è
                if (opt.length > 4) btn.style.fontSize = "32px";
                else btn.style.fontSize = "42px";

                let correctAns = qData.a || qData.q;
                btn.onclick = () => checkAnswer(btn, opt, correctAns, type);
                optContainer.appendChild(btn);
            });
        }

        function checkAnswer(btn, selected, correct, type) {
            if (selected === correct) {
                btn.classList.add('correct');
                score++;
                document.getElementById('score').innerText = score;
                setTimeout(() => nextQuizQuestion(type), 800);
            } else {
                btn.classList.add('wrong');
            }
        }

        function startMath(config) {
            score = 0;
            document.getElementById('score').innerText = 0;
            mathConfig = config;
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="quiz-container">
                    <canvas id="clock-canvas" width="280" height="280" class="hidden"></canvas>
                    <div class="card" style="padding: 15px;">
                        <div id="math-q" class="q-text" style="font-size:80px;"></div>
                        <div id="math-sub" class="q-sub"></div>
                        <div id="math-input" style="font-size:60px !important; color:#4a90e2; border-bottom:3px solid #ddd; height:70px; width:100%; margin-top:10px;"></div>
                    </div>
                    <div class="numpad">
                        <button class="num-btn" onclick="inputNum(1)">1</button>
                        <button class="num-btn" onclick="inputNum(2)">2</button>
                        <button class="num-btn" onclick="inputNum(3)">3</button>
                        <button class="num-btn" onclick="inputNum(4)">4</button>
                        <button class="num-btn" onclick="inputNum(5)">5</button>
                        <button class="num-btn" onclick="inputNum(6)">6</button>
                        <button class="num-btn" onclick="inputNum(7)">7</button>
                        <button class="num-btn" onclick="inputNum(8)">8</button>
                        <button class="num-btn" onclick="inputNum(9)">9</button>
                        <button class="num-btn" onclick="inputNum('C')" style="color:orange;">C</button>
                        <button class="num-btn" onclick="inputNum(0)">0</button>
                        <button class="num-btn action-btn" onclick="checkMath()">OK</button>
                        <button id="half-btn" class="num-btn half-btn hidden" onclick="inputNum(':30')">üïí Âçä (:30)</button>
                    </div>
                    <button class="btn" onclick="backToMenu()" style="margin-top:30px; color:#888; font-size:20px; background:none;">‚¨ÖÔ∏è ÁµêÊùüÁ∑¥Áøí</button>
                </div>`;
            nextMathQuestion();
        }

        function nextMathQuestion() {
            inputBuffer = "";
            document.getElementById('math-input').innerText = "";
            document.getElementById('half-btn').classList.add('hidden');
            document.getElementById('clock-canvas').classList.add('hidden');
            document.getElementById('math-q').classList.remove('hidden');

            let config = mathConfig;
            let qText = "", qSub = "", ans = "";
            let currentType = config.type;
            if (config.type === 'mix') {
                const types = ['add', 'sub', 'decomp', 'clock'];
                currentType = types[Math.floor(Math.random() * types.length)];
            }

            if (currentType === 'add') {
                let a = Math.floor(Math.random() * (config.range + 1));
                let b = Math.floor(Math.random() * (config.range + 1 - a));
                qText = `${a} + ${b} = ?`; ans = (a+b).toString();
            } else if (currentType === 'sub') {
                let a = Math.floor(Math.random() * (config.range + 1));
                let b = Math.floor(Math.random() * (a + 1));
                qText = `${a} - ${b} = ?`; ans = (a-b).toString();
            } else if (currentType === 'decomp') {
                let total = Math.floor(Math.random() * (config.range - 1)) + 2; 
                let p1 = Math.floor(Math.random() * total);
                qText = `${total} ÂèØ‰ª•ÂàÜÊàê`; qSub = `${p1} Âíå ?`; ans = (total - p1).toString();
            } else if (currentType === 'count') {
                let count = Math.floor(Math.random() * config.range) + 1;
                let icons = ['üçé', 'üçå', 'üçá', 'üçä', 'üçâ', 'üçí', 'üê∂', 'üê±', 'üê∞', 'üöó', '‚úàÔ∏è', '‚öΩ', '‚≠êÔ∏è', 'üç™', 'üéà'];
                let icon = icons[Math.floor(Math.random() * icons.length)];
                qText = `<div style="display:flex; flex-wrap:wrap; justify-content:center; gap:5px;">${icon.repeat(count)}</div>`;
                qSub = "ÊúâÂπæÂÄã?"; ans = count.toString();
            } else if (currentType === 'clock') {
                document.getElementById('clock-canvas').classList.remove('hidden');
                document.getElementById('math-q').classList.add('hidden');
                let h = Math.floor(Math.random() * 12) + 1;
                let m = 0;
                let isHalf = (config.range === 'half' || (config.type === 'mix' && Math.random() > 0.5)) && Math.random() > 0.5;
                if (isHalf) m = 30;
                drawClock(h, m);
                qSub = "ÁèæÂú®ÊòØÂπæÈªûÔºü";
                ans = m === 30 ? `${h}:30` : `${h}:00`;
                if (m === 30) document.getElementById('half-btn').classList.remove('hidden');
            }

            currentQ = { ans: ans, type: currentType };
            document.getElementById('math-q').innerHTML = qText;
            document.getElementById('math-sub').innerText = qSub;
        }

        function inputNum(val) {
            if (val === 'C') { inputBuffer = ""; }
            else {
                if (val === ':30' && (inputBuffer.includes(':') || inputBuffer === '')) return;
                if (inputBuffer.length > 5) return;
                inputBuffer += val;
            }
            document.getElementById('math-input').innerText = inputBuffer;
        }

        function checkMath() {
            let isCorrect = false;
            let correctAns = currentQ.ans;
            if ((currentQ.type === 'clock' || mathConfig.type === 'mix') && correctAns.endsWith(":00")) {
                if (inputBuffer === correctAns || inputBuffer === correctAns.split(":")[0]) isCorrect = true;
            } else {
                if (inputBuffer === correctAns) isCorrect = true;
            }

            const inputDiv = document.getElementById('math-input');
            if (isCorrect) {
                inputDiv.style.color = "#28a745";
                score++;
                document.getElementById('score').innerText = score;
                setTimeout(() => nextMathQuestion(), 600);
            } else {
                inputDiv.style.color = "#dc3545";
                setTimeout(() => { inputBuffer = ""; inputDiv.innerText = ""; inputDiv.style.color = "#4a90e2"; }, 500);
            }
        }

        function backToMenu() {
            if (currentRole === 'hunter') { showHunterCategories(); } 
            else { showAngusCategories(); }
        }

        function speakCurrent() {
            if (!currentQ) return;
            let text = currentQ.speak || currentQ.audio || currentQ.q;
            if (!text || text.includes('<div') || text.includes('?')) return; 
            let u = new SpeechSynthesisUtterance(text);
            u.lang = /[a-zA-Z]/.test(text) ? 'en-US' : 'zh-TW';
            u.rate = 0.8;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(u);
        }
        function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }
        function drawClock(hour, minute) {
            const canvas = document.getElementById('clock-canvas');
            const ctx = canvas.getContext('2d');
            const r = canvas.width / 2;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.translate(r, r);
            ctx.beginPath(); ctx.arc(0, 0, r - 5, 0, 2 * Math.PI); ctx.fillStyle = "white"; ctx.fill(); ctx.strokeStyle = "#333"; ctx.lineWidth = 4; ctx.stroke();
            for(let i=0; i<12; i++){ ctx.beginPath(); ctx.rotate(Math.PI / 6); ctx.moveTo(0, - (r - 15)); ctx.lineTo(0, - (r - 5)); ctx.stroke(); }
            let hAngle = (hour % 12) * Math.PI / 6 + (minute * Math.PI / (6 * 60));
            let mAngle = minute * Math.PI / 30;
            ctx.strokeStyle = "#333"; ctx.lineWidth = 8; ctx.lineCap = "round"; ctx.beginPath(); ctx.rotate(hAngle); ctx.moveTo(0, 0); ctx.lineTo(0, -r * 0.5); ctx.stroke(); ctx.rotate(-hAngle);
            ctx.strokeStyle = "#e74c3c"; ctx.lineWidth = 5; ctx.beginPath(); ctx.rotate(mAngle); ctx.moveTo(0, 0); ctx.lineTo(0, -r * 0.75); ctx.stroke(); ctx.rotate(-mAngle);
            ctx.beginPath(); ctx.arc(0, 0, 6, 0, 2*Math.PI); ctx.fillStyle = "#333"; ctx.fill(); ctx.translate(-r, -r);
        }
    </script>
</body>
</html>
