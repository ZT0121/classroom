<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StudyMode</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#5d8b27">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
    <link rel="manifest" href="manifest.json">

    <style>
        /* 1. å­—é«”è¨­å®š */
        @font-face {
            font-family: 'ZhuyinFont';
            src: url('./fonts/zhuyin.ttf') format('truetype'),
                 url('zhuyin.ttf') format('truetype');
            font-display: swap;
        }

        :root {
            --primary: #5d8b27;   /* MC è‰åœ°ç¶  */
            --hunter-bg: #e3f2fd;
            --angus-bg: #fff3cd;
        }

        body {
            font-family: "Microsoft JhengHei", -apple-system, sans-serif;
            background: #e0f7fa;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* ğŸ› ï¸ ä¿®æ­£ï¼šæŠŠ .score-text åŠ é€²é€™è£¡ï¼Œå¼·åˆ¶å¥—ç”¨æ³¨éŸ³å­—é«” */
        .role-info h2, .role-info p, .menu-title, .menu-sub, .q-text, .q-sub, .opt-btn, .hint-toggle, .use-zhuyin, .btn, .score-text {
            font-family: 'ZhuyinFont', "Microsoft JhengHei", sans-serif !important;
            font-weight: normal;
        }

        /* é˜²ä½œå¼Š & æ•¸å­¸æ•¸å­—ï¼šç¶­æŒé»‘é«” */
        .no-zhuyin, .math-num {
            font-family: "Microsoft JhengHei", -apple-system, sans-serif !important;
        }

        .math-num { font-weight: bold; margin: 0 5px; vertical-align: baseline; }

        /* é€šç”¨å…ƒä»¶ */
        .hidden { display: none !important; }
        .btn { border: none; border-radius: 16px; cursor: pointer; transition: 0.2s; font-weight: bold; outline: none; display: flex; align-items: center; justify-content: center; }
        .btn:active { transform: scale(0.96); }
        .icon-btn { background: #eee; width: 60px; height: 60px; border-radius: 50%; font-size: 30px; border: none; cursor: pointer; }
        
        /* å°è¦½åˆ— */
        .navbar { width: 100%; padding: 15px 25px; background: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; box-sizing: border-box; }
        .score-board { font-size: 20px; color: #555; font-weight: bold; display: flex; align-items: center; gap: 5px; }

        /* é¦–é  & é›†é»å¡ */
        #home-view { display: flex; flex-direction: column; gap: 20px; margin-top: 5vh; width: 90%; max-width: 450px; }
        
        /* â›ï¸ Minecraft é›†é»å¡æ¨£å¼ */
        .score-card { 
            background: white; 
            padding: 20px; 
            border-radius: 20px; 
            box-shadow: 0 8px 0 #ccc; 
            text-align: center; 
            border: 4px solid #333;
        }
        
        .stamp-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr); 
            gap: 10px;
            margin: 15px 0;
            justify-items: center;
        }
        
        .stamp-box {
            width: 45px;
            height: 45px;
            background: #ddd;
            border: 2px solid #999;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: transparent; 
            transition: all 0.3s;
        }
        
        /* ç²å¾—æ˜Ÿæ˜Ÿçš„æ¨£å¼ */
        .stamp-box.active {
            background: #81c784; 
            border-color: #2e7d32;
            color: #fff; 
            box-shadow: 0 0 10px #81c784;
        }

        .admin-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .role-card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 5px 0 #ccc; display: flex; align-items: center; gap: 25px; cursor: pointer; transition: 0.2s; border: 2px solid #eee; }
        .role-card:active { transform: translateY(4px); box-shadow: none; }
        .role-avatar { font-size: 50px; background: #f0f0f0; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .role-info h2 { margin: 0; font-size: 32px; color: #333; }
        .role-info p { margin: 8px 0 0; color: #888; font-size: 18px; }
        
        .hunter-app { background: #e3f2fd; }
        .angus-app { background: #fff3cd; }
        
        .menu-list { display: grid; grid-template-columns: 1fr; gap: 15px; width: 90%; max-width: 550px; padding: 20px 0; }
        .menu-item { background: white; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-left: 10px solid var(--primary); display: flex !important; width: 100% !important; box-sizing: border-box; min-height: 100px; justify-content: center; align-items: center; }
        .menu-title { font-size: 36px; color: #333; margin: 0; display: inline-block; line-height: 1.4; white-space: nowrap; }
        .menu-sub { font-size: 18px; color: #888; display: block; margin-top: 5px; }

        .quiz-container { width: 95%; max-width: 900px; display: flex; flex-direction: column; align-items: center; padding-top: 20px; }
        .card { background: white; width: 100%; padding: 40px 20px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; margin-bottom: 30px; position: relative; box-sizing: border-box; }
        
        .q-text { 
            font-size: 70px; color: #333; margin: 20px 0; min-height: 120px; 
            display: flex; flex-direction: row; flex-wrap: wrap; justify-content: center; align-items: center; 
            line-height: 1.3; word-wrap: break-word; white-space: normal; 
        }
        
        .q-sub { font-size: 24px; color: #666; margin-top: 5px; margin-bottom: 15px; white-space: nowrap; }

        .options-grid { display: flex; width: 100%; gap: 15px; flex-direction: row; justify-content: center; flex-wrap: wrap; }
        .opt-btn { background: white; border: 4px solid #f0f0f0; padding: 10px; font-size: 36px; border-radius: 20px; color: #555; min-height: 120px; box-shadow: 0 6px 0 #ddd; box-sizing: border-box; display: flex; align-items: center; justify-content: center; flex: 1; min-width: 140px; max-width: 300px; white-space: nowrap; }
        .opt-btn:active { transform: translateY(6px); box-shadow: none; }
        .opt-btn.correct { background: #d4edda; border-color: #28a745; color: #155724; box-shadow: 0 6px 0 #1e7e34; }
        .opt-btn.wrong { background: #f8d7da; border-color: #dc3545; color: #721c24; box-shadow: 0 6px 0 #bd2130; }

        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; max-width: 500px; }
        .num-btn { background: white; padding: 20px; font-size: 32px; border-radius: 15px; box-shadow: 0 6px 0 #ccc; color: #333; border: 1px solid #ddd; }
        .num-btn:active { box-shadow: none; transform: translateY(6px); }
        .action-btn { background: var(--primary); color: white; box-shadow: 0 6px 0 #2a6bb3; border: none; }
        .half-btn { grid-column: span 3; background: #e1f5fe; font-size: 26px; }

        #math-input { font-size: 60px !important; height: 70px !important; margin-bottom: 20px; }
        .hint-toggle { margin-top: 15px; background: #fff3cd; color: #856404; padding: 10px 25px; font-size: 20px; border-radius: 25px; }
        canvas { background: white; border-radius: 50%; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px; max-width: 100%; }
    </style>
</head>
<body>

    <nav id="navbar" class="navbar hidden">
        <div class="btn" onclick="goHome()" style="font-size:24px;">ğŸ </div>
        <div id="nav-title" style="font-size: 20px; color:#4a90e2;" class="use-zhuyin">StudyMode</div>
        <div class="score-board">â­ <span id="score-display" class="score-text">0</span></div>
    </nav>

    <div id="home-view">
        <div class="score-card">
            <h2 class="use-zhuyin" style="margin:0; color:#333; font-size:28px;">â›ï¸ Minecraft é›†é»å¡</h2>
            <div class="use-zhuyin" style="color:#666; font-size:16px; margin-top:5px;">é›†æ»¿ 10 é»æ› 20 åˆ†é˜ Minecraft éŠæˆ²æ™‚é–“</div>
            
            <div class="stamp-grid" id="stamp-grid">
                </div>

            <div id="stamp-status" class="score-text" style="margin: 10px 0; font-size: 20px; color: #555; font-weight:bold;">
                ç›®å‰é›†é»ï¼š0 é»
            </div>

            <div class="admin-controls">
                <button class="btn" onclick="addManualStamp()" 
                    style="background:#2196F3; color:white; flex:1; padding:10px; font-size:18px; border-bottom: 4px solid #0d47a1;">
                    â• å®¶é•·è“‹ç« 
                </button>
                <button id="redeem-btn" class="btn hidden" onclick="redeemReward()" 
                    style="background:#4CAF50; color:white; flex:1; padding:10px; font-size:18px; border-bottom: 4px solid #2e7d32;">
                    ğŸ å…Œæ›çå‹µ
                </button>
            </div>
        </div>

        <div class="role-card" onclick="selectRole('hunter')" style="border-left: 6px solid #4facfe;">
            <div class="role-avatar" style="background:#e3f2fd;">ğŸ‘¦</div>
            <div class="role-info">
                <h2>Hunter</h2>
                <p>åœ‹èªã€æ•¸å­¸ã€è‹±æ–‡</p>
            </div>
        </div>
        <div class="role-card" onclick="selectRole('angus')" style="border-left: 6px solid #ff9a9e;">
            <div class="role-avatar" style="background:#fff3cd;">ğŸ‘¶</div>
            <div class="role-info">
                <h2>Angus</h2>
                <p>æ³¨éŸ³ã€æ•¸ó ‡¡æ•¸ã€æ™‚é˜</p>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden"></div>

    <script src="questions.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() { navigator.serviceWorker.register('./service-worker.js'); });
        }
        
        window.onload = function() {
            if (typeof DB === 'undefined') alert("âš ï¸ éŒ¯èª¤ï¼šè®€ä¸åˆ° questions.js");
            loadUserData();
            initStampGrid();
            updateScoreUI();
        };

        let currentRole = null;
        let totalScore = 0;   
        let stampCount = 0;   
        const GOAL_STAMPS = 10; 
        
        let currentQ = null;
        let lastMathQ = ""; 
        let inputBuffer = ""; 
        let mathConfig = null;

        function loadUserData() {
            let savedScore = localStorage.getItem('totalScore');
            if (savedScore) totalScore = parseInt(savedScore);

            let savedStamps = localStorage.getItem('stampCount');
            if (savedStamps) stampCount = parseInt(savedStamps);
        }

        function addScore() {
            totalScore++;
            localStorage.setItem('totalScore', totalScore);
            updateScoreUI();
        }

        function addManualStamp() {
            let pwd = prompt("è«‹è¼¸å…¥å¯†ç¢¼ä¾†è“‹ç« ï¼š");
            if (pwd === "0329") {
                stampCount++;
                localStorage.setItem('stampCount', stampCount);
                updateScoreUI();
                alert("è“‹ç« æˆåŠŸï¼ğŸ‰");
            } else if (pwd !== null) {
                alert("å¯†ç¢¼éŒ¯èª¤ ğŸš«");
            }
        }

        function initStampGrid() {
            const grid = document.getElementById('stamp-grid');
            grid.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                let box = document.createElement('div');
                box.className = 'stamp-box';
                box.innerText = 'â˜…';
                grid.appendChild(box);
            }
        }

        function updateScoreUI() {
            document.getElementById('score-display').innerText = totalScore;
            document.getElementById('stamp-status').innerText = `ç›®å‰é›†é»ï¼š${stampCount} é»`;

            const boxes = document.querySelectorAll('.stamp-box');
            let displayCount = Math.min(stampCount, 10);
            
            boxes.forEach((box, index) => {
                if (index < displayCount) {
                    box.classList.add('active');
                } else {
                    box.classList.remove('active');
                }
            });

            const redeemBtn = document.getElementById('redeem-btn');
            if (stampCount >= GOAL_STAMPS) {
                redeemBtn.classList.remove('hidden');
            } else {
                redeemBtn.classList.add('hidden');
            }
        }

        function redeemReward() {
            let pwd = prompt("è«‹è¼¸å…¥å¯†ç¢¼é€²è¡Œå…Œæ›ï¼š");
            if (pwd === "0329") {
                if (confirm(`ç¢ºå®šè¦ç”¨ 10 é»å…Œæ› Minecraft 20 åˆ†é˜å—ï¼Ÿ\n(ç›®å‰å…±æœ‰ ${stampCount} é»)`)) {
                    stampCount -= GOAL_STAMPS; 
                    localStorage.setItem('stampCount', stampCount);
                    updateScoreUI();
                    alert("ğŸ‰ å…Œæ›æˆåŠŸï¼ç²å¾— 20 åˆ†é˜éŠæˆ²æ™‚é–“ï¼â›ï¸");
                }
            } else if (pwd !== null) {
                alert("å¯†ç¢¼éŒ¯èª¤ ğŸš«");
            }
        }

        function selectRole(role) {
            currentRole = role;
            document.getElementById('home-view').classList.add('hidden');
            document.getElementById('navbar').classList.remove('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            document.body.className = role === 'hunter' ? 'hunter-app' : 'angus-app';
            document.getElementById('nav-title').innerText = role === 'hunter' ? 'Hunter å°ˆå±¬' : 'Angus å°ˆå±¬';
            
            if (role === 'hunter') { showHunterCategories(); } 
            else { showAngusCategories(); }
        }

        function goHome() {
            document.getElementById('home-view').classList.remove('hidden');
            document.getElementById('navbar').classList.add('hidden');
            document.getElementById('app-container').classList.add('hidden');
            document.body.className = '';
            currentRole = null;
            updateScoreUI(); 
        }

        // --- é¸å–®èˆ‡é¡Œç›®é‚è¼¯ ---

        function showHunterCategories() {
            const container = document.getElementById('app-container');
            container.innerHTML = `<div class="menu-list" id="menu-list"></div>`;
            const list = document.getElementById('menu-list');
            addMenuItem(list, "ğŸ“š åœ‹èª", "", () => showHunterSubject('chinese'), '#ff9a9e');
            addMenuItem(list, "ğŸ”¢ æ•¸å­¸", "", () => showHunterSubject('math'), '#4facfe');
            addMenuItem(list, "ğŸ”¤ è‹±æ–‡", "", () => showHunterSubject('english'), '#a8e6cf');
        }

        function showHunterSubject(subject) {
            const container = document.getElementById('app-container');
            container.innerHTML = `<div class="menu-list" id="menu-list"></div>`;
            const list = document.getElementById('menu-list');
            addBackBtn(list, "â¬…ï¸ å›ç§‘ç›®é¸å–®", () => showHunterCategories());

            if (subject === 'chinese') {
                addMenuItem(list, "åœˆè©æ³¨éŸ³ç·´ç¿’", "è½éŸ³é¸æ³¨éŸ³", () => startQuiz('h_zhuyin'));
            } else if (subject === 'math') {
                if(DB.hunter.mathUnits) {
                    DB.hunter.mathUnits.forEach(u => addMenuItem(list, u.name, u.desc, () => startMath(u)));
                }
            } else if (subject === 'english') {
                addMenuItem(list, "é›™èªç¹ªæœ¬å–®å­—", "è½éŸ³è¾¨å­—", () => startQuiz('h_english'));
            }
        }

        function showAngusCategories() {
            const container = document.getElementById('app-container');
            container.innerHTML = `<div class="menu-list" id="menu-list"></div>`;
            const list = document.getElementById('menu-list');
            addMenuItem(list, "ğŸ—£ï¸ æ³¨éŸ³", "", () => showAngusSubject('zhuyin'), '#ffd1dc');
            addMenuItem(list, "ğŸ æ•¸ó ‡¡æ•¸", "", () => showAngusSubject('math'), '#fff5ba');
            addMenuItem(list, "ğŸ¶ è‹±æ–‡", "", () => showAngusSubject('english'), '#baffc9');
        }

        function showAngusSubject(subject) {
            const container = document.getElementById('app-container');
            container.innerHTML = `<div class="menu-list" id="menu-list"></div>`;
            const list = document.getElementById('menu-list');
            addBackBtn(list, "â¬…ï¸ å›å»é¸åˆ¥çš„", () => showAngusCategories());

            if (subject === 'zhuyin') {
                addMenuItem(list, "æ³¨éŸ³ç¬¦è™Ÿæ‰¾æ‰¾çœ‹", "", () => startQuiz('a_zhuyin'));
            } else if (subject === 'math') {
                if(DB.angus.mathUnits) {
                    DB.angus.mathUnits.forEach(u => addMenuItem(list, u.name, u.desc, () => startMath(u)));
                }
            } else if (subject === 'english') {
                addMenuItem(list, "ç°¡å–®å–®å­—", "", () => startQuiz('a_english'));
            }
        }

        function addMenuItem(parent, title, sub, action, color) {
            const btn = document.createElement('button');
            btn.className = 'menu-item btn';
            if (color) btn.style.borderLeftColor = color; 
            let htmlContent = (sub && sub !== "") ? 
                `<div><span class="menu-title">${title}</span><span class="menu-sub">${sub}</span></div>` :
                `<span class="menu-title" style="margin:0;">${title}</span>`;
            btn.innerHTML = htmlContent;
            btn.onclick = action;
            parent.appendChild(btn);
        }

        function addBackBtn(parent, title, action) {
            const btn = document.createElement('button');
            btn.className = 'menu-item btn';
            btn.style.background = '#f8f9fa'; 
            btn.style.borderLeft = 'none';
            btn.style.boxShadow = 'none';
            btn.style.border = '2px dashed #ddd';
            btn.innerHTML = `<span class="menu-title" style="font-size:24px; color:#888; margin:0;">${title}</span>`;
            btn.onclick = action;
            parent.appendChild(btn);
        }

        function generateOptionsFromDB(correctAnswer, sourceArray, count = 3) {
            let options = new Set();
            options.add(correctAnswer); 
            let safeLimit = 100; 
            while (options.size < count && safeLimit > 0) {
                safeLimit--;
                let randomItem = sourceArray[Math.floor(Math.random() * sourceArray.length)];
                let val = (typeof randomItem === 'string') ? randomItem : randomItem.a;
                if (val && val !== correctAnswer) options.add(val);
            }
            return Array.from(options);
        }

        function startQuiz(type) {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <div class="quiz-container">
                    <div class="card">
                        <button class="icon-btn" onclick="speakCurrent()">ğŸ”Š</button>
                        <div id="q-display" class="q-text"></div>
                        <div id="q-sub-display" class="q-sub"></div>
                        <div id="hint-btn" class="hidden"></div>
                    </div>
                    <div id="opt-container" class="options-grid"></div>
                    <button class="btn" onclick="backToMenu()" style="margin-top:30px; color:#888; font-size:20px; background:none;">â¬…ï¸ çµæŸç·´ç¿’</button>
                </div>`;
            nextQuizQuestion(type);
        }

        function nextQuizQuestion(type) {
            let qData, options;
            
            try {
                if (type === 'h_zhuyin') { 
                    do { qData = getRandom(DB.hunter.chinese_zhuyin); } 
                    while (currentQ && qData.q === currentQ.q && DB.hunter.chinese_zhuyin.length > 1);
                    options = shuffle(generateOptionsFromDB(qData.a, DB.hunter.chinese_zhuyin));
                }
                else if (type === 'h_english') { 
                    do { qData = getRandom(DB.hunter.english); } 
                    while (currentQ && qData.q === currentQ.q && DB.hunter.english.length > 1);
                    let wrongs = DB.hunter.english.filter(x => x.q !== qData.q).map(x => x.q);
                    options = shuffle([qData.q, ...shuffle(wrongs).slice(0,3)]);
                }
                else if (type === 'a_zhuyin') {
                    let char;
                    do { char = getRandom(DB.angus.zhuyin); } 
                    while (currentQ && char === currentQ.a && DB.angus.zhuyin.length > 1);
                    qData = { q: "?", a: char, audio: char, speak: "è«‹æ‰¾å‡º "+char };
                    let wrongs = DB.angus.zhuyin.filter(x => x !== char);
                    options = shuffle([char, ...shuffle(wrongs).slice(0,3)]);
                }
                else if (type === 'a_english') {
                    do { qData = getRandom(DB.angus.english); } 
                    while (currentQ && qData.q === currentQ.q && DB.angus.english.length > 1);
                    let wrongs = DB.angus.english.filter(x => x.q !== qData.q).map(x => x.q);
                    options = shuffle([qData.q, ...shuffle(wrongs).slice(0,3)]);
                }
            } catch (e) { console.error(e); return; }

            currentQ = qData;
            const display = document.getElementById('q-display');
            const subDisplay = document.getElementById('q-sub-display');
            subDisplay.innerHTML = "";

            if (type === 'h_zhuyin') {
                display.className = 'q-text no-zhuyin'; 
                display.innerHTML = qData.q;
            } else {
                display.className = 'q-text use-zhuyin'; 
                if (type.includes('english')) {
                    display.innerHTML = (currentRole === 'hunter') ? "???" : qData.hint;
                } else if (type === 'a_zhuyin') {
                    display.innerHTML = "?";
                }
            }

            let textLen = display.innerText.length;
            if (textLen <= 1) display.style.fontSize = "100px";
            else if (textLen === 2) display.style.fontSize = "80px";
            else if (textLen >= 3) display.style.fontSize = "70px"; 

            const hintDiv = document.getElementById('hint-btn');
            if (type === 'h_english' && qData.hint) {
                hintDiv.className = 'btn hint-toggle';
                hintDiv.innerText = "ğŸ’¡ çœ‹æç¤º";
                hintDiv.onclick = () => { display.innerText = qData.hint; };
                hintDiv.classList.remove('hidden');
            } else { hintDiv.classList.add('hidden'); }

            setTimeout(() => speakCurrent(), 300);

            const optContainer = document.getElementById('opt-container');
            optContainer.innerHTML = '';
            options.forEach(opt => {
                let btn = document.createElement('button');
                btn.className = 'opt-btn btn';
                btn.innerText = opt;
                if (opt.length > 4) btn.style.fontSize = "24px";
                else btn.style.fontSize = "36px";
                let correctAns = qData.a || qData.q;
                btn.onclick = () => checkAnswer(btn, opt, correctAns, type);
                optContainer.appendChild(btn);
            });
        }

        function checkAnswer(btn, selected, correct, type) {
            if (selected === correct) {
                btn.classList.add('correct');
                addScore(); 
                setTimeout(() => nextQuizQuestion(type), 800);
            } else {
                btn.classList.add('wrong');
            }
        }

        function startMath(config) {
            const container = document.getElementById('app-container');
            mathConfig = config;
            container.innerHTML = `
                <div class="quiz-container">
                    <canvas id="clock-canvas" width="280" height="280" class="hidden"></canvas>
                    <div class="card" style="padding: 15px;">
                        <div id="math-q" class="q-text" style="font-size:80px;"></div>
                        <div id="math-sub" class="q-sub"></div>
                        <div id="math-input" style="font-size:60px !important; color:#4a90e2; border-bottom:3px solid #ddd; height:70px; width:100%; margin-top:10px;"></div>
                    </div>
                    <div class="numpad">
                        <button class="num-btn" onclick="inputNum(1)">1</button>
                        <button class="num-btn" onclick="inputNum(2)">2</button>
                        <button class="num-btn" onclick="inputNum(3)">3</button>
                        <button class="num-btn" onclick="inputNum(4)">4</button>
                        <button class="num-btn" onclick="inputNum(5)">5</button>
                        <button class="num-btn" onclick="inputNum(6)">6</button>
                        <button class="num-btn" onclick="inputNum(7)">7</button>
                        <button class="num-btn" onclick="inputNum(8)">8</button>
                        <button class="num-btn" onclick="inputNum(9)">9</button>
                        <button class="num-btn" onclick="inputNum('C')" style="color:orange;">C</button>
                        <button class="num-btn" onclick="inputNum(0)">0</button>
                        <button class="num-btn action-btn" onclick="checkMath()">OK</button>
                        <button id="half-btn" class="num-btn half-btn hidden" onclick="inputNum(':30')">ğŸ•’ åŠ (:30)</button>
                    </div>
                    <button class="btn" onclick="backToMenu()" style="margin-top:30px; color:#888; font-size:20px; background:none;">â¬…ï¸ çµæŸç·´ç¿’</button>
                </div>`;
            nextMathQuestion();
        }

function nextMathQuestion() {
            inputBuffer = "";
            document.getElementById('math-input').innerText = "";
            document.getElementById('half-btn').classList.add('hidden');
            document.getElementById('clock-canvas').classList.add('hidden');
            
            const mathQ = document.getElementById('math-q');
            if(mathQ) mathQ.classList.remove('hidden');

            let config = mathConfig;
            let qText = "", qSub = "", ans = "";
            let currentType = config.type;
            let speakText = "";

            let maxTries = 10;
            let uniqueFound = false;
            let finalQStr = "";

            do {
                // æ··åˆæ¨¡å¼ï¼šåŠ å…¥ seq (é †åº)
                if (config.type === 'mix') {
                    const types = ['add', 'sub', 'decomp', 'clock', 'seq'];
                    currentType = types[Math.floor(Math.random() * types.length)];
                }

                if (currentType === 'add') {
                    let a = Math.floor(Math.random() * (config.range + 1));
                    let b = Math.floor(Math.random() * (config.range + 1 - a));
                    qText = `<span class='math-num'>${a}</span> + <span class='math-num'>${b}</span> =`; 
                    qSub = "";
                    ans = (a+b).toString();
                } else if (currentType === 'sub') {
                    let a = Math.floor(Math.random() * (config.range + 1));
                    let b = Math.floor(Math.random() * (a + 1));
                    qText = `<span class='math-num'>${a}</span> - <span class='math-num'>${b}</span> =`; 
                    qSub = "";
                    ans = (a-b).toString();
                } else if (currentType === 'decomp') {
                    let total = Math.floor(Math.random() * (config.range - 1)) + 2; 
                    let p1 = Math.floor(Math.random() * total);
                    qText = `<span class='math-num'>${total}</span> å¯ä»¥åˆ†æˆ <span class='math-num'>${p1}</span> å’Œ <span class='math-num'>?</span>`; 
                    qSub = ""; 
                    ans = (total - p1).toString();
                } else if (currentType === 'count') {
                    let count = Math.floor(Math.random() * config.range) + 1;
                    let icons = ['ğŸ', 'ğŸŒ', 'ğŸ‡', 'ğŸŠ', 'ğŸ‰', 'ğŸ’', 'ğŸ¶', 'ğŸ±', 'ğŸ°', 'ğŸš—', 'âœˆï¸', 'âš½', 'â­ï¸', 'ğŸª', 'ğŸˆ'];
                    let icon = icons[Math.floor(Math.random() * icons.length)];
                    qText = `<div style="display:flex; flex-wrap:wrap; justify-content:center; gap:5px; line-height:1.2;">${icon.repeat(count)}</div>`;
                    qSub = ""; 
                    ans = count.toString();
                    speakText = "æœ‰å¹¾å€‹ï¼Ÿ";
                } else if (currentType === 'seq') { // ğŸ› ï¸ æ–°å¢ï¼šé †åºé¡Œ
                    // å‹•ç‰©æ± 
                    let animals = ['ğŸ­','ğŸ®','ğŸ¯','ğŸ°','ğŸ²','ğŸ','ğŸ´','ğŸ‘','ğŸµ','ğŸ”','ğŸ¶','ğŸ·'];
                    // éš¨æ©ŸæŠ“ 5 éš»ä¸é‡è¤‡çš„å‹•ç‰©æ’éšŠ
                    let queue = [];
                    while(queue.length < 5) {
                        let a = animals[Math.floor(Math.random() * animals.length)];
                        if(!queue.includes(a)) queue.push(a);
                    }
                    
                    // é¸ä¸€å€‹ä¸»è§’
                    let targetIndex = Math.floor(Math.random() * 5);
                    let target = queue[targetIndex];
                    
                    // éš¨æ©Ÿæ±ºå®šå•å·¦é‚Šé‚„æ˜¯å³é‚Š
                    let isFromLeft = Math.random() > 0.5;
                    let directionStr = isFromLeft ? "å·¦é‚Š" : "å³é‚Š";
                    
                    // è¨ˆç®—ç­”æ¡ˆ (ç¬¬å¹¾å€‹)
                    let correctPos = isFromLeft ? (targetIndex + 1) : (5 - targetIndex);
                    ans = correctPos.toString();
                    
                    // é¡¯ç¤ºé¡Œç›® (ç”¨ div åŒ…è£¹è®“ Emoji æ’åˆ—æ•´é½Š)
                    qText = `<div style="font-size:60px; letter-spacing:5px; margin-bottom:10px;">${queue.join('')}</div>`;
                    qSub = `å¾${directionStr}æ•¸ï¼Œ${target}æ˜¯ç¬¬å¹¾å€‹ï¼Ÿ`;
                } else if (currentType === 'clock') {
                    let h = Math.floor(Math.random() * 12) + 1;
                    let m = 0;
                    let isHalf = (config.range === 'half' || (config.type === 'mix' && Math.random() > 0.5)) && Math.random() > 0.5;
                    if (isHalf) m = 30;
                    drawClock(h, m);
                    qText = "ç¾åœ¨æ˜¯å¹¾é»ï¼Ÿ";
                    qSub = "";
                    ans = m === 30 ? `${h}:30` : `${h}:00`;
                    finalQStr = `${h}:${m}`;
                    uniqueFound = true; 
                }

                if (currentType !== 'clock') finalQStr = qText + qSub; // åŠ å…¥ qSub åˆ¤æ–·é¿å…é‡è¤‡
                if (finalQStr !== lastMathQ) uniqueFound = true;

            } while (!uniqueFound && maxTries-- > 0);

            lastMathQ = finalQStr;

            if (currentType === 'clock') {
                document.getElementById('clock-canvas').classList.remove('hidden');
                mathQ.innerText = qText;
                mathQ.style.fontSize = "50px"; 
                if (ans.endsWith(':30')) document.getElementById('half-btn').classList.remove('hidden');
            } else {
                if (currentType !== 'count') currentQ = { ans: ans, type: currentType };
                
                mathQ.innerHTML = qText;
                mathQ.style.fontSize = (currentType === 'seq') ? "60px" : "80px"; // é †åºé¡Œå­—é«”å¾®èª¿
                
                document.getElementById('math-sub').innerHTML = qSub; 
            }
            
            currentQ = { ans: ans, type: currentType, speak: speakText };
            if(speakText) setTimeout(() => speakCurrent(), 300);
        }
        
        function inputNum(val) {
            if (val === 'C') { inputBuffer = ""; }
            else {
                if (val === ':30' && (inputBuffer.includes(':') || inputBuffer === '')) return;
                if (inputBuffer.length > 5) return;
                inputBuffer += val;
            }
            document.getElementById('math-input').innerText = inputBuffer;
        }

        function checkMath() {
            let isCorrect = false;
            let correctAns = currentQ.ans;
            if ((currentQ.type === 'clock' || mathConfig.type === 'mix') && correctAns.endsWith(":00")) {
                if (inputBuffer === correctAns || inputBuffer === correctAns.split(":")[0]) isCorrect = true;
            } else {
                if (inputBuffer === correctAns) isCorrect = true;
            }

            const inputDiv = document.getElementById('math-input');
            if (isCorrect) {
                inputDiv.style.color = "#28a745";
                addScore(); 
                setTimeout(() => nextMathQuestion(), 600);
            } else {
                inputDiv.style.color = "#dc3545";
                setTimeout(() => { inputBuffer = ""; inputDiv.innerText = ""; inputDiv.style.color = "#4a90e2"; }, 500);
            }
        }

        function backToMenu() {
            if (currentRole === 'hunter') { showHunterCategories(); } 
            else { showAngusCategories(); }
        }

        function speakCurrent() {
            if (!currentQ) return;
            let text = currentQ.speak || currentQ.audio || currentQ.q;
            if (!text) return; 
            let u = new SpeechSynthesisUtterance(text);
            u.lang = /[a-zA-Z]/.test(text) ? 'en-US' : 'zh-TW';
            u.rate = 0.8;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(u);
        }
        function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }
        function drawClock(hour, minute) {
            const canvas = document.getElementById('clock-canvas');
            const ctx = canvas.getContext('2d');
            const r = canvas.width / 2;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.translate(r, r);
            ctx.beginPath(); ctx.arc(0, 0, r - 5, 0, 2 * Math.PI); ctx.fillStyle = "white"; ctx.fill(); ctx.strokeStyle = "#333"; ctx.lineWidth = 4; ctx.stroke();
            for(let i=0; i<12; i++){ ctx.beginPath(); ctx.rotate(Math.PI / 6); ctx.moveTo(0, - (r - 15)); ctx.lineTo(0, - (r - 5)); ctx.stroke(); }
            let hAngle = (hour % 12) * Math.PI / 6 + (minute * Math.PI / (6 * 60));
            let mAngle = minute * Math.PI / 30;
            ctx.strokeStyle = "#333"; ctx.lineWidth = 8; ctx.lineCap = "round"; ctx.beginPath(); ctx.rotate(hAngle); ctx.moveTo(0, 0); ctx.lineTo(0, -r * 0.5); ctx.stroke(); ctx.rotate(-hAngle);
            ctx.strokeStyle = "#e74c3c"; ctx.lineWidth = 5; ctx.beginPath(); ctx.rotate(mAngle); ctx.moveTo(0, 0); ctx.lineTo(0, -r * 0.75); ctx.stroke(); ctx.rotate(-mAngle);
            ctx.beginPath(); ctx.arc(0, 0, 6, 0, 2*Math.PI); ctx.fillStyle = "#333"; ctx.fill(); ctx.translate(-r, -r);
        }
    </script>
</body>
</html>
